<style>
    /* ==================== äº‹ä»¶ç´€éŒ„ç·¨è¼¯ Modal (é¡å ±å‘Šé¢¨æ ¼ V5) ==================== */

    #event-log-modal .modal-content {
        max-width: 1100px; /* é©åº¦å¯¬åº¦ */
    }
    
    #event-log-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: var(--spacing-4);
        margin-bottom: var(--spacing-6);
    }

    /* --- å€å¡Šå…±ç”¨æ¨£å¼ --- */
    .edit-section-block {
        margin-bottom: var(--spacing-6);
        padding-bottom: var(--spacing-6);
        border-bottom: 1px solid var(--border-color);
    }
    .edit-section-block:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .section-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--spacing-5);
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--glass-bg);
        padding: 8px 12px;
        border-radius: 6px;
    }

    /* --- å ±å‘Šå¼è¡¨å–®ä½ˆå±€ (æ ¸å¿ƒ CSS) --- */
    /* å°‡ form-group æ”¹é€ æˆ Gridï¼Œæ¨¡ä»¿å ±å‘Šçš„ .info-item */
    .report-like-form .form-group {
        display: grid;
        grid-template-columns: 120px 1fr; /* å·¦æ¨™é¡Œå›ºå®šå¯¬ | å³å…§å®¹è‡ªé©æ‡‰ */
        gap: 16px;
        align-items: center; /* å‚ç›´ç½®ä¸­ */
        margin-bottom: 12px;
    }
    
    .report-like-form .form-label {
        text-align: right;
        margin-bottom: 0; /* æŠµæ¶ˆåŸæœ¬çš„ margin */
        color: var(--text-muted);
        font-size: 0.95rem;
        font-weight: 600;
        padding-top: 0;
    }

    /* è¼¸å…¥æ¡†æ¨£å¼å¾®èª¿ï¼šæ¨¡ä»¿å ±å‘Šçš„ .info-value-box */
    .report-like-form .form-input,
    .report-like-form .form-textarea {
        background-color: var(--primary-bg); /* ä½¿ç”¨è¼ƒæ·±çš„èƒŒæ™¯è‰² */
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 1rem;
        color: var(--text-primary);
        transition: all 0.2s ease;
        box-shadow: none; /* ç§»é™¤åŸæœ¬è¼ƒé‡çš„é™°å½± */
    }

    .report-like-form .form-input:focus,
    .report-like-form .form-textarea:focus {
        background-color: var(--secondary-bg);
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15); /* æŸ”å’Œå…‰æšˆ */
    }
    
    /* --- ç¬¬ä¸€å€å¡Šï¼šé¡å‹é¸æ“‡ (4æ¬„å¡ç‰‡) --- */
    .type-select-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: var(--spacing-5);
    }
    .type-select-card {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 6px;
    }
    .type-select-card:hover {
        background: var(--glass-bg);
        border-color: var(--accent-blue);
        transform: translateY(-2px);
    }
    .type-select-card.selected {
        background: color-mix(in srgb, var(--accent-blue) 10%, var(--secondary-bg));
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 1px var(--accent-blue);
    }
    .type-select-icon { font-size: 1.5rem; }
    .type-select-title { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); }

    /* --- ç¬¬äºŒå€å¡Šï¼šé›™æ¬„ä½ˆå±€ --- */
    .split-layout-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px; /* å¢åŠ æ¬„é–“è· */
        align-items: start;
    }
    
    /* å³æ¬„ï¼šåƒèˆ‡äººå“¡ (è† å›Šæ¨£å¼) */
    .tags-input-container {
        background: var(--primary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        min-height: 42px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    .participant-pill-tag {
        padding: 4px 12px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background-color: var(--secondary-bg);
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
    }
    .participant-pill-tag:hover { border-color: var(--accent-blue); color: var(--text-primary); }
    .participant-pill-tag.selected {
        background-color: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
    }
    
    /* ç´…è‰²è­¦ç¤ºæ¡†æ¨£å¼ (ä¿®æ­£æ­·å²æ™‚é–“) */
    .warning-input {
        border-color: var(--accent-red) !important;
        background-color: color-mix(in srgb, var(--accent-red) 5%, var(--primary-bg)) !important;
    }
    .warning-hint {
        color: var(--accent-red);
        font-size: 0.8rem;
        margin-top: 4px;
        display: block;
        text-align: right; /* é å³å°é½Šè¼¸å…¥æ¡† */
    }
    
    /* é‡å°å‹•æ…‹è¼‰å…¥çš„è¡¨å–®å…§å®¹ï¼Œä¹Ÿå¥—ç”¨å ±å‘Šæ¨£å¼ */
    #event-form-container .form-group {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 16px;
        align-items: start; /* å¤šè¡Œæ–‡å­—æ¡†éœ€è¦é ä¸Šå°é½Š */
        margin-bottom: 12px;
    }
    #event-form-container .form-label {
        text-align: right;
        margin-bottom: 0;
        color: var(--text-muted);
        font-size: 0.95rem;
        font-weight: 600;
        padding-top: 10px; /* èˆ‡ input æ–‡å­—åŸºç·šå°é½Š */
    }

    /* éŸ¿æ‡‰å¼èª¿æ•´ */
    @media (max-width: 768px) {
        .report-like-form .form-group, 
        #event-form-container .form-group {
            grid-template-columns: 1fr; /* æ‰‹æ©Ÿä¸Šæ¢å¾©å‚ç›´å †ç–Š */
            gap: 6px;
        }
        .report-like-form .form-label,
        #event-form-container .form-label {
            text-align: left;
            padding-top: 0;
        }
        .split-layout-container {
            grid-template-columns: 1fr;
            gap: var(--spacing-6);
        }
        .type-select-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* --- ä¿ç•™ Wizard æ¨£å¼ (å‹¿åˆª) --- */
    .wizard-steps { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 20px; }
    .step-item { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; color: var(--text-muted); font-weight: 500; opacity: 0.6; transition: all 0.3s ease; }
    .step-item.active { color: var(--accent-blue); opacity: 1; }
    .step-circle { width: 36px; height: 36px; border-radius: 50%; background-color: var(--card-bg); border: 2px solid var(--text-muted); display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 8px; transition: all 0.3s ease; }
    .step-item.active .step-circle { border-color: var(--accent-blue); background-color: var(--accent-blue); color: white; box-shadow: 0 0 10px rgba(96, 165, 250, 0.4); }
    .step-line { flex-grow: 1; height: 2px; background-color: var(--border-color); margin: 0 15px; margin-bottom: 20px; }
    .event-entry-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
    .event-entry-card { background: var(--card-bg); border: 2px solid var(--border-color); border-radius: var(--rounded-lg); padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .event-entry-card:hover { border-color: var(--accent-blue); background: var(--glass-bg); transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .event-entry-card.selected { border-color: var(--accent-blue); background: color-mix(in srgb, var(--accent-blue) 10%, var(--card-bg)); }
    .type-entry-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .type-card { background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px 10px; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 12px; height: 100%; }
    .type-card:hover { background: var(--glass-bg); border-color: var(--accent-blue); transform: translateY(-2px); }
    .type-card.selected { background: color-mix(in srgb, var(--accent-blue) 10%, var(--secondary-bg)); border-color: var(--accent-blue); box-shadow: 0 0 0 1px var(--accent-blue); }
    .type-icon { font-size: 1.5rem; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: var(--primary-bg); border-radius: 50%; flex-shrink: 0; margin-bottom: 5px; }
    .tag-selection-area { background: var(--glass-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .tag-group-label { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; display: block; }
    .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .wiz-tag { padding: 6px 14px; border: 1px solid var(--border-color); border-radius: 20px; background-color: var(--secondary-bg); color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; cursor: pointer; user-select: none; transition: all 0.2s ease; }
    .wiz-tag:hover { border-color: var(--accent-blue); }
    .wiz-tag.selected { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
</style>

<div id="event-log-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="event-log-modal-title">âœï¸ ç·¨è¼¯äº‹ä»¶ç´€éŒ„</h2>
            <div class="action-buttons">
                <button class="close-btn" onclick="closeModal('event-log-modal')">&times;</button>
            </div>
        </div>
        
        <form id="event-log-form" class="report-like-form">
            <input type="hidden" id="event-log-eventId" name="eventId">
            <input type="hidden" id="event-log-opportunityId" name="opportunityId">
            <input type="hidden" id="event-log-companyId" name="companyId">
            <input type="hidden" id="event-log-type" name="eventType">

            <div id="event-link-section" style="display: none;"></div>

            <div class="edit-section-block">
                <div class="section-title">1. äº‹ä»¶å®šç¾©</div>
                
                <div class="type-select-grid">
                    <div class="type-select-card" data-type="general" onclick="selectEventTypeForEdit('general', this)">
                        <div class="type-select-icon">ğŸ“</div>
                        <div class="type-select-title">ä¸€èˆ¬ç´€éŒ„</div>
                    </div>
                    <div class="type-select-card" data-type="iot" onclick="selectEventTypeForEdit('iot', this)">
                        <div class="type-select-icon">ğŸ­</div>
                        <div class="type-select-title">IoT (ç‰©è¯ç¶²)</div>
                    </div>
                    <div class="type-select-card" data-type="dt" onclick="selectEventTypeForEdit('dt', this)">
                        <div class="type-select-icon">ğŸ“Š</div>
                        <div class="type-select-title">DT (æ•¸ä½é›™ç”Ÿ)</div>
                    </div>
                    <div class="type-select-card" data-type="dx" onclick="selectEventTypeForEdit('dx', this)">
                        <div class="type-select-icon">ğŸš€</div>
                        <div class="type-select-title">DX (é–‹ç™¼æ¡ˆä»¶)</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="event-log-name" class="form-label">äº‹ä»¶åç¨± *</label>
                    <input type="text" class="form-input" id="event-log-name" name="eventName" required placeholder="ä¾‹å¦‚ï¼šéœ€æ±‚è¨ªè«‡ã€ç”¢å“ç°¡å ±...">
                </div>
            </div>

            <div class="edit-section-block">
                <div class="split-layout-container">
                    <div class="left-col">
                        <div class="section-title">2. æ™‚ç©ºè³‡è¨Š</div>
                        
                        <div class="form-group">
                            <label for="event-log-createdTime" class="form-label" style="color:var(--accent-red);">ç™¼ç”Ÿæ™‚é–“</label>
                            <div>
                                <input type="datetime-local" class="form-input warning-input" id="event-log-createdTime" name="createdTime">
                                <small class="warning-hint">âš ï¸ ä¿®æ”¹æ­¤æ¬„ä½å°‡è®Šæ›´æ­·å²æ’åº</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="event-log-location" class="form-label">æœƒè­°åœ°é»</label>
                            <input type="text" class="form-input" id="event-log-location" name="visitPlace" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ¶æœƒè­°å®¤ã€ç·šä¸Š...">
                        </div>
                    </div>

                    <div class="right-col">
                        <div class="section-title">3. èˆ‡æœƒäººå“¡</div>
                        
                        <div class="form-group">
                            <label class="form-label">æˆ‘æ–¹äººå“¡</label>
                            <div id="edit-our-participants-container" class="tags-input-container">
                                <span style="color: var(--text-muted); font-size: 0.9rem;">è¼‰å…¥ä¸­...</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">å®¢æˆ¶äººå“¡</label>
                            <div style="width: 100%;">
                                <div id="edit-client-participants-container" class="tags-input-container" style="margin-bottom: 8px;">
                                    <span style="color: var(--text-muted); font-size: 0.9rem;">è¼‰å…¥ä¸­...</span>
                                </div>
                                <input type="text" class="form-input" id="edit-manual-participants" placeholder="å…¶ä»–äººå“¡ (é€—è™Ÿåˆ†éš”)..." style="font-size: 0.9rem;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="edit-section-block" style="border-bottom: none;">
                <div class="section-title">4. è©³ç´°å…§å®¹</div>
                <div id="event-form-container"></div>
            </div>

            <div class="btn-group" style="margin-top: 0; padding-top: 0; border-top: none;">
                <button type="button" class="action-btn danger" id="event-log-delete-btn" style="display: none; margin-right: auto;">ğŸ—‘ï¸ åˆªé™¤äº‹ä»¶</button>
                <button type="submit" class="action-btn primary" id="event-log-submit-btn">ğŸ’¾ å„²å­˜è®Šæ›´</button>
            </div>
        </form>
    </div>
</div>

<div id="new-event-wizard-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 class="modal-title">ğŸ“ æ–°å¢äº‹ä»¶ç´€éŒ„</h2>
            <button class="close-btn" onclick="closeModal('new-event-wizard-modal')">&times;</button>
        </div>
        <div class="wizard-steps">
            <div class="step-item active" data-wiz-step="1"><div class="step-circle">1</div><div class="step-label">é–å®šå°è±¡</div></div>
            <div class="step-line"></div>
            <div class="step-item" data-wiz-step="2"><div class="step-circle">2</div><div class="step-label">å®šç¾©äº‹ä»¶</div></div>
            <div class="step-line"></div>
            <div class="step-item" data-wiz-step="3"><div class="step-circle">3</div><div class="step-label">èˆ‡æœƒäººå“¡</div></div>
        </div>
        <form id="event-wizard-form" onsubmit="return false;">
            <div class="wizard-step-content" data-wiz-content="1">
                <h3 class="step-instruction">è«‹å•é€™å€‹äº‹ä»¶çš„é—œè¯å°è±¡æ˜¯ï¼Ÿ</h3>
                <div class="event-entry-grid">
                    <div class="event-entry-card" onclick="EventWizard.selectTargetType('opportunity', this)">
                        <div class="entry-icon" style="width: 60px; height: 60px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center;">ğŸ¯</div>
                        <div class="entry-title">æ©Ÿæœƒæ¡ˆä»¶</div>
                        <div class="entry-desc">ä»£è¡¨ç‰¹å®šçš„åˆä½œæˆ–è¨‚å–®ï¼Œ<br>å¦‚MTUï¼Œæ©Ÿæœƒå°å‘çš„äº‹ä»¶ç´€éŒ„ã€‚</div>
                    </div>
                    <div class="event-entry-card" onclick="EventWizard.selectTargetType('company', this)">
                        <div class="entry-icon" style="width: 60px; height: 60px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center;">ğŸ¢</div>
                        <div class="entry-title">å…¬å¸ç¸½è¦½</div>
                        <div class="entry-desc">äº’å‹•ä¸­æ²’æœ‰ç‰¹å®šçš„æ©ŸæœƒèƒŒæ™¯ï¼Œ<br>å¦‚SIã€ä»£ç†å•†ã€MTBçš„å•†è«‡ç´€éŒ„</div>
                    </div>
                </div>
                <div id="wiz-target-search-area" style="margin-top: 20px; display: none;">
                     <div class="form-group"><label class="form-label" id="wiz-search-label">æœå°‹åç¨±</label><div class="search-input-wrapper"><input type="text" class="form-input" id="wiz-target-search" placeholder="é»æ“Šè¼¸å…¥æœå°‹ï¼Œæˆ–ç›´æ¥å¾ä¸‹æ–¹é¸æ“‡..." onkeyup="EventWizard.searchTargets(this.value)" onclick="EventWizard.searchTargets(this.value)"></div><div id="wiz-target-results" class="search-result-list"></div></div>
                </div>
            </div>
            <div class="wizard-step-content" data-wiz-content="2" style="display: none;">
                <div class="type-entry-grid">
                    <div class="type-card selected" onclick="EventWizard.selectEventType('general', this)"><div class="type-icon">ğŸ“</div><div class="type-info"><div class="type-title">ä¸€èˆ¬ç´€éŒ„</div><div class="type-desc"></div></div></div>
                    <div class="type-card" onclick="EventWizard.selectEventType('iot', this)"><div class="type-icon">ğŸ­</div><div class="type-info"><div class="type-title">IoT</div><div class="type-desc"></div></div></div>
                    <div class="type-card" onclick="EventWizard.selectEventType('dt', this)"><div class="type-icon">ğŸ“Š</div><div class="type-info"><div class="type-title">DT</div><div class="type-desc"></div></div></div>
                    <div class="type-card" onclick="EventWizard.selectEventType('dx', this)"><div class="type-icon">ğŸš€</div><div class="type-info"><div class="type-title">DX</div><div class="type-desc"></div></div></div>
                </div>
                <div class="form-row"><div class="form-group"><label class="form-label">äº‹ä»¶åç¨± *</label><input type="text" class="form-input" id="wiz-event-name" placeholder="ä¾‹å¦‚ï¼šéœ€æ±‚è¨ªè«‡ã€ç”¢å“ç°¡å ±..."></div><div class="form-group"><label class="form-label">ç™¼ç”Ÿæ™‚é–“ *</label><input type="datetime-local" class="form-input" id="wiz-event-time"></div></div>
                <div class="form-group"><label class="form-label">æœƒè­°åœ°é»</label><input type="text" class="form-input" id="wiz-event-location" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ¶æœƒè­°å®¤ã€Teamsç·šä¸Š..."></div>
            </div>
            <div class="wizard-step-content" data-wiz-content="3" style="display: none;">
                <h3 class="step-instruction">è«‹å•æœ‰å“ªäº›äººåƒèˆ‡ï¼Ÿ</h3>
                <div class="tag-selection-area"><span class="tag-group-label">æˆ‘æ–¹äººå“¡ (é»æ“Šé¸å–)</span><div class="tags-container" id="wiz-our-participants"><span style="color: var(--text-muted);">è¼‰å…¥ä¸­...</span></div></div>
                <div class="tag-selection-area"><span class="tag-group-label">å®¢æˆ¶äººå“¡ (é»æ“Šé¸å–)</span><div class="tags-container" id="wiz-client-participants"><span style="color: var(--text-muted);">è«‹å…ˆé–å®šå°è±¡ä»¥è¼‰å…¥è¯çµ¡äºº</span></div></div>
                <div class="form-group"><input type="text" class="form-input" id="wiz-manual-participants" placeholder="æ‰‹å‹•è¼¸å…¥å…¶ä»–èˆ‡æœƒè€… (ç”¨é€—è™Ÿåˆ†éš”)"></div>
            </div>
            <div class="wizard-footer">
                <button type="button" class="action-btn secondary" id="wiz-prev-btn" onclick="EventWizard.prevStep()" style="display: none;">&lt; ä¸Šä¸€æ­¥</button>
                <span style="flex-grow: 1;"></span>
                <button type="button" class="action-btn primary" id="wiz-next-btn" onclick="EventWizard.nextStep()">ä¸‹ä¸€æ­¥ &gt;</button>
                <button type="button" class="action-btn primary" id="wiz-create-btn" onclick="EventWizard.create()" style="display: none;">âœ… å»ºç«‹ä¸¦ç·¨è¼¯è©³æƒ…</button>
            </div>
        </form>
    </div>
</div>