// public/scripts/opportunity-details/opportunity-details-components.js
// è·è²¬ï¼šæ•´åˆæ©Ÿæœƒè©³ç´°é é¢çµ„ä»¶ï¼Œè™•ç†ç·¨è¼¯é‚è¼¯èˆ‡è³‡æ–™å­˜å–
// (ä¾è³´ OpportunityInfoView é€²è¡Œé¡¯ç¤ºæ¨¡å¼æ¸²æŸ“)

function _injectStylesForOppInfoCard() {
    const styleId = 'opportunity-info-card-container-styles';
    if (document.getElementById(styleId)) return;

    const style = document.createElement('style');
    style.id = styleId;
    style.innerHTML = `
        /* å®¹å™¨åŸºç¤æ¨£å¼ */
        .opportunity-info-card {
            background-color: var(--secondary-bg);
            padding: var(--spacing-6);
            border-radius: var(--rounded-xl);
            border: 1px solid var(--border-color);
            margin-bottom: var(--spacing-6);
            transition: all 0.3s ease;
        }
        /* ç·¨è¼¯æ¨¡å¼å°ˆç”¨æ¨£å¼ (ä¿ç•™åŸæœ¬é‚è¼¯) */
        .info-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editing .info-card-header {
            padding-bottom: var(--spacing-4);
            margin-bottom: var(--spacing-4);
            border-bottom: 1px solid var(--border-color);
        }
        .edit-form-columns { display: flex; gap: var(--spacing-8); align-items: flex-start; }
        .form-col { flex: 1; display: flex; flex-direction: column; gap: var(--spacing-5); min-width: 0; }
        @media (max-width: 900px) { .edit-form-columns { flex-direction: column; gap: var(--spacing-6); } }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: var(--font-size-sm); color: var(--text-muted); font-weight: 500; }
        .form-input, .form-select, .form-textarea {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--rounded-md);
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }
        .form-input:read-only, .form-select:disabled, .form-input:disabled { 
            background-color: var(--secondary-bg); 
            cursor: not-allowed; 
            opacity: 0.7; 
            color: var(--text-muted); 
            border-color: var(--border-color);
        }
        .pills-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .info-option-pill {
            padding: 6px 14px; border-radius: var(--rounded-full); font-size: 0.85rem; border: 1px solid var(--border-color);
            cursor: pointer; background: var(--primary-bg); color: var(--text-muted); transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 6px; user-select: none;
        }
        .info-option-pill:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        .info-option-pill.selected {
            background: color-mix(in srgb, var(--accent-blue) 15%, transparent); color: var(--accent-blue);
            border-color: var(--accent-blue); font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .pill-quantity { display: inline-block; padding: 0px 6px; font-size: 0.75rem; font-weight: 700; background-color: var(--accent-blue); color: white; border-radius: var(--rounded-md); }
        .spec-category-group { margin-bottom: 8px; }
        .spec-category-title { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 600; }
        .spec-pills-wrapper { display: flex; flex-wrap: wrap; gap: 8px; }
        .manual-override-label { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-secondary); cursor: pointer; margin-top: 4px; }
        .notes-section { margin-top: var(--spacing-6); padding-top: var(--spacing-4); border-top: 1px solid var(--border-color); }
    `;
    document.head.appendChild(style);
}

const OpportunityInfoCard = (() => {
    let _currentOpp = null;

    async function _getCompanyList() {
        if (window.CRM_APP && window.CRM_APP.companyList && window.CRM_APP.companyList.length > 0) return window.CRM_APP.companyList;
        try {
            const response = await authedFetch('/api/companies');
            if (response.success) {
                if (window.CRM_APP) window.CRM_APP.companyList = response.data;
                return response.data;
            }
        } catch (e) { console.error('ç²å–å…¬å¸åˆ—è¡¨å¤±æ•—', e); }
        return [];
    }

    function render(opp) {
        _currentOpp = opp;
        _injectStylesForOppInfoCard();
        const container = document.getElementById('opportunity-info-card-container');
        if (!container) return;

        // ã€ä¿®æ”¹é»ã€‘ç›´æ¥å‘¼å« OpportunityInfoView ä¾†ç”¢ç”Ÿé¡¯ç¤ºæ¨¡å¼ HTML
        const displayModeHtml = OpportunityInfoView 
            ? OpportunityInfoView.render(opp) 
            : '<div class="alert alert-error">View Module Missing</div>';

        container.innerHTML = `
            <div id="opportunity-info-display-mode">
                ${displayModeHtml}
            </div>
            <div id="opportunity-info-edit-mode" style="display: none;">
                </div>
        `;

        // é å…ˆç”Ÿæˆç·¨è¼¯è¡¨å–®ï¼Œä»¥ä¾¿åˆ‡æ›æ™‚ä½¿ç”¨
        _generateEditFormHTML(opp).then(html => {
            const editContainer = document.getElementById('opportunity-info-edit-mode');
            if (editContainer) {
                editContainer.innerHTML = html;
                _initCascadingLogic(opp);
            }
        });
    }

    // ================== ä»¥ä¸‹ç‚ºç·¨è¼¯æ¨¡å¼é‚è¼¯ (ä¿æŒåŸæ¨£æˆ–å¾®èª¿) ==================

    function _renderPillsGroup(configKey, currentValue, fieldId) {
        const systemConfig = window.CRM_APP ? window.CRM_APP.systemConfig : {};
        const options = systemConfig[configKey] || [];
        
        let pillsHtml = '';
        options.forEach(opt => {
            const isSelected = opt.value === currentValue;
            pillsHtml += `
                <span class="info-option-pill single-select ${isSelected ? 'selected' : ''}" 
                      data-value="${opt.value}" 
                      data-field-target="${fieldId}"
                      onclick="OpportunityInfoCardEvents.handleSingleSelectClick(this)">
                    ${opt.note || opt.value}
                </span>
            `;
        });
        
        return `
            <div class="pills-container single-select-container">
                ${pillsHtml}
                <input type="hidden" id="edit-${fieldId}" value="${currentValue || ''}">
            </div>
        `;
    }

    function _renderCustomPillsGroup(options, currentValue, fieldId, clickHandler) {
        let pillsHtml = '';
        options.forEach(opt => {
            const isSelected = opt === currentValue;
            pillsHtml += `
                <span class="info-option-pill single-select ${isSelected ? 'selected' : ''}" 
                      data-value="${opt}" 
                      data-field-target="${fieldId}"
                      onclick="${clickHandler}(this)">
                    ${opt}
                </span>
            `;
        });
        
        return `
            <div class="pills-container single-select-container">
                ${pillsHtml}
                <input type="hidden" id="edit-${fieldId}" value="${currentValue || ''}">
            </div>
        `;
    }

    function _renderSpecsGroup(opp) {
        const systemConfig = window.CRM_APP ? window.CRM_APP.systemConfig : {};
        const specsConfig = systemConfig['å¯èƒ½ä¸‹å–®è¦æ ¼'] || [];
        
        let specQuantities = new Map();
        try {
            const parsed = JSON.parse(opp.potentialSpecification);
            if (parsed && typeof parsed === 'object') specQuantities = new Map(Object.entries(parsed));
        } catch (e) {}

        const groups = new Map();
        specsConfig.forEach(spec => {
            const cat = spec.category || 'å…¶ä»–';
            if (!groups.has(cat)) groups.set(cat, []);
            groups.get(cat).push(spec);
        });

        let html = '<div id="spec-pills-container" class="form-group">';
        groups.forEach((items, category) => {
            let pillsHtml = '';
            items.forEach(spec => {
                const quantity = specQuantities.get(spec.value) || 0;
                const isSelected = specQuantities.has(spec.value);
                let qtyHtml = '';
                if (isSelected && spec.value3 === 'allow_quantity' && quantity > 0) {
                    qtyHtml = `<span class="pill-quantity" data-spec-id="${spec.value}">(x${quantity})</span>`;
                }
                pillsHtml += `
                    <span class="info-option-pill ${isSelected ? 'selected' : ''}" 
                          data-spec-id="${spec.value}" 
                          title="${spec.note}">
                        ${spec.note || spec.value}
                        ${qtyHtml}
                    </span>
                `;
            });
            html += `
                <div class="spec-category-group">
                    <div class="spec-category-title">â–¼ ${category}</div>
                    <div class="spec-pills-wrapper">${pillsHtml}</div>
                </div>
            `;
        });
        html += '</div>';
        return html;
    }

    async function _generateEditFormHTML(opp) {
        const salesModel = opp.salesModel || 'ç›´æ¥è²©å”®';
        const isManualValue = opp.opportunityValueType === 'manual';
        const formattedValue = (opp.opportunityValue || '0').replace(/,/g, '');
        const salesModelOptions = ['ç›´æ¥è²©å”®', 'ç¶“ç”±SIè²©å”®', 'ç¶“ç”±MTBè²©å”®'];
        
        const createdDate = opp.createdTime ? opp.createdTime.split('T')[0] : '';
        const expectedDate = opp.expectedCloseDate ? opp.expectedCloseDate.split('T')[0] : '';

        return `
            <div class="info-card-header">
                <h2 class="widget-title" style="margin: 0;">ç·¨è¼¯æ ¸å¿ƒè³‡è¨Š</h2>
                <div style="display: flex; gap: 8px;">
                    <button class="action-btn small secondary" onclick="OpportunityInfoCardEvents.toggleEditMode(false)">å–æ¶ˆ</button>
                    <button class="action-btn small primary" onclick="OpportunityInfoCardEvents.save()">ğŸ’¾ å„²å­˜</button>
                </div>
            </div>

            <div class="edit-form-columns">
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label">æ©Ÿæœƒåç¨±</label>
                        <input type="text" id="edit-opportunity-name" class="form-input" value="${opp.opportunityName || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">éŠ·å”®æ¨¡å¼</label>
                        ${_renderCustomPillsGroup(salesModelOptions, salesModel, 'sales-model', 'OpportunityInfoCardEvents.handleSalesModelPillClick')}
                    </div>

                    <div class="form-group">
                        <label class="form-label">çµ‚ç«¯å®¢æˆ¶ (å®¢æˆ¶å…¬å¸)</label>
                        <select id="edit-customer-company" class="form-select" onchange="OpportunityInfoCardEvents.handleCustomerChange(this.value)">
                            <option value="">è¼‰å…¥ä¸­...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çµ‚ç«¯çª—å£ (è¯çµ¡äºº)</label>
                        <select id="edit-main-contact" class="form-select">
                            <option value="">è¼‰å…¥ä¸­...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä¸»è¦é€šè·¯/ä¸‹å–®æ–¹ (å…¬å¸é¸æ“‡)</label>
                        <select id="edit-channel-details" class="form-select" onchange="OpportunityInfoCardEvents.handleChannelChange(this.value)">
                            <option value="">è¼‰å…¥ä¸­...</option>
                        </select>
                        <input type="hidden" id="edit-sales-channel" value="${opp.salesChannel || ''}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">é€šè·¯çª—å£ (è¯çµ¡äºº)</label>
                        <select id="edit-channel-contact" class="form-select">
                            <option value="">-- è«‹å…ˆé¸æ“‡é€šè·¯å…¬å¸ --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ©Ÿæœƒåƒ¹å€¼</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="edit-opportunity-value" class="form-input" 
                                   value="${formattedValue}" ${isManualValue ? '' : 'disabled'} style="flex:1;">
                        </div>
                        <label class="manual-override-label">
                            <input type="checkbox" id="value-manual-override-checkbox" 
                                   onchange="OpportunityInfoCardEvents.handleManualOverride(this)"
                                   ${isManualValue ? 'checked' : ''}>
                            æ‰‹å‹•è¦†è“‹è‡ªå‹•è¨ˆç®—
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è² è²¬æ¥­å‹™</label>
                        ${_renderPillsGroup('åœ˜éšŠæˆå“¡', opp.assignee, 'assignee')}
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ©Ÿæœƒç¨®é¡</label>
                        ${_renderPillsGroup('æ©Ÿæœƒç¨®é¡', opp.opportunityType, 'opportunity-type')}
                    </div>

                    <div class="form-group">
                        <label class="form-label">è¨­å‚™è¦æ¨¡</label>
                        ${_renderPillsGroup('è¨­å‚™è¦æ¨¡', opp.deviceScale, 'device-scale')}
                    </div>
                </div>

                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label">ä¸‹å–®æ©Ÿç‡</label>
                        ${_renderPillsGroup('ä¸‹å–®æ©Ÿç‡', opp.orderProbability, 'order-probability')}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å»ºç«‹æ©Ÿæœƒæ—¥æœŸ</label>
                        <input type="date" id="edit-created-time" class="form-input" 
                               value="${createdDate}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">é è¨ˆçµæ¡ˆæ—¥</label>
                        <input type="date" id="edit-expected-close-date" class="form-input" 
                               value="${expectedDate}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ç›®å‰éšæ®µ</label>
                        ${_renderPillsGroup('æ©Ÿæœƒéšæ®µ', opp.currentStage, 'current-stage')}
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ©Ÿæœƒä¾†æº</label>
                        ${_renderPillsGroup('æ©Ÿæœƒä¾†æº', opp.opportunitySource, 'opportunity-source')}
                    </div>

                    <div class="form-group">
                        <label class="form-label">å¯èƒ½ä¸‹å–®è¦æ ¼ (è¤‡é¸)</label>
                        ${_renderSpecsGroup(opp)}
                    </div>
                </div>
            </div>

            <div class="notes-section">
                <div class="form-group">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea id="edit-notes" class="form-textarea" rows="3">${opp.notes || ''}</textarea>
                </div>
            </div>
        `;
    }

    async function _initCascadingLogic(opp) {
        const companies = await _getCompanyList();
        
        // 1. åˆå§‹åŒ–ã€Œçµ‚ç«¯å®¢æˆ¶ã€ä¸‹æ‹‰é¸å–®
        const customerSelect = document.getElementById('edit-customer-company');
        if (customerSelect) {
            customerSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
            companies.forEach(c => {
                const option = document.createElement('option');
                option.value = c.companyName;
                option.text = c.companyName;
                if (c.companyName === opp.customerCompany) option.selected = true;
                customerSelect.add(option);
            });
        }

        // 3. é€£å‹•é‚è¼¯ (éŠ·å”®æ¨¡å¼ -> é€šè·¯åˆ—è¡¨)
        await handleSalesModelChange(opp.salesModel || 'ç›´æ¥è²©å”®', false);
    }

    async function handleSalesModelChange(modelValue, resetValue = true) {
        const channelSelect = document.getElementById('edit-channel-details');
        const channelContactSelect = document.getElementById('edit-channel-contact');
        const customerSelect = document.getElementById('edit-customer-company');
        
        if (!channelSelect || !customerSelect) return;

        const currentCustomer = customerSelect.value;
        const savedChannelDetails = _currentOpp ? (_currentOpp.channelDetails || '') : '';
        const companies = await _getCompanyList();
        
        channelSelect.innerHTML = '';
        
        if (modelValue === 'ç›´æ¥è²©å”®') {
            const option = document.createElement('option');
            option.value = currentCustomer;
            option.text = currentCustomer ? `${currentCustomer} (ç›´è²©)` : '-- åŒçµ‚ç«¯å®¢æˆ¶ --';
            option.selected = true;
            channelSelect.add(option);
            
            channelSelect.disabled = true; 

            if (channelContactSelect) {
                channelContactSelect.innerHTML = '<option value="">-- ä¸é©ç”¨ --</option>';
                channelContactSelect.disabled = true;
            }

        } else {
            channelSelect.disabled = false;

            const typeKeyword = modelValue.includes('SI') ? 'SI' : (modelValue.includes('MTB') ? 'MTB' : '');
            let filteredCompanies = companies.filter(c => {
                const type = (c.companyType || c.type || '').toUpperCase();
                return type.includes(typeKeyword);
            });
            if (filteredCompanies.length === 0 && companies.length > 0) filteredCompanies = companies;

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.text = "-- è«‹é¸æ“‡åˆä½œå¤¥ä¼´ --";
            channelSelect.add(defaultOption);

            filteredCompanies.forEach(c => {
                const option = document.createElement('option');
                option.value = c.companyName;
                option.text = c.companyName;
                
                if (!resetValue && c.companyName === savedChannelDetails) {
                    option.selected = true;
                }
                channelSelect.add(option);
            });
            
            if (!resetValue && savedChannelDetails && !filteredCompanies.some(c => c.companyName === savedChannelDetails)) {
                 const option = document.createElement('option');
                 option.value = savedChannelDetails;
                 option.text = savedChannelDetails + ' (éæ¸…å–®)';
                 option.selected = true;
                 channelSelect.add(option);
            }
            
            if (channelContactSelect && resetValue) {
                channelContactSelect.innerHTML = '<option value="">-- è«‹å…ˆé¸æ“‡é€šè·¯å…¬å¸ --</option>';
                channelContactSelect.disabled = true; 
            }
        }
    }

    return { render, handleSalesModelChange };
})();

// OpportunityAssociatedOpps ä¿æŒä¸è®Š
const OpportunityAssociatedOpps = (() => {
    async function _handleRemoveParentLink(opportunityId, rowIndex) {
        showConfirmDialog('æ‚¨ç¢ºå®šè¦ç§»é™¤æ­¤æ¯æ©Ÿæœƒé—œè¯å—ï¼Ÿ', async () => {
            showLoading('æ­£åœ¨ç§»é™¤é—œè¯...');
            try {
                const result = await authedFetch(`/api/opportunities/${rowIndex}`, {
                    method: 'PUT',
                    body: JSON.stringify({ parentOpportunityId: '', modifier: getCurrentUser() })
                });
                if (!result.success) throw new Error(result.error || 'ç§»é™¤å¤±æ•—');
            } catch (error) {
                if (error.message !== 'Unauthorized') showNotification(`ç§»é™¤é—œè¯å¤±æ•—: ${error.message}`, 'error');
            } finally { hideLoading(); }
        });
    }

    function render(details) {
        const container = document.getElementById('associated-opportunities-list');
        const addButton = document.getElementById('add-associated-opportunity-btn');
        if (!container || !addButton) return;
        const { opportunityInfo, parentOpportunity, childOpportunities } = details;
        let html = '';
        addButton.style.display = 'flex'; 
        addButton.onclick = () => showLinkOpportunityModal(opportunityInfo.opportunityId, opportunityInfo.rowIndex);
        if (parentOpportunity) {
            html += `<div class="summary-item" style="margin-bottom: 1rem;"><span class="summary-label">æ¯æ©Ÿæœƒ</span><div style="display: flex; align-items: center; gap: 10px;"><span class="summary-value" style="font-size: 1rem;"><a href="#" class="text-link" onclick="event.preventDefault(); CRM_APP.navigateTo('opportunity-details', { opportunityId: '${parentOpportunity.opportunityId}' })">${parentOpportunity.opportunityName}</a></span><button class="action-btn small danger" style="padding: 2px 6px; font-size: 0.7rem;" onclick="OpportunityAssociatedOpps._handleRemoveParentLink('${opportunityInfo.opportunityId}', ${opportunityInfo.rowIndex})" title="ç§»é™¤æ¯æ©Ÿæœƒé—œè¯">ç§»é™¤</button></div></div>`;
            addButton.textContent = 'âœï¸ è®Šæ›´æ¯æ©Ÿæœƒ';
        } else { addButton.textContent = '+ è¨­å®šæ¯æ©Ÿæœƒ'; }
        if (childOpportunities && childOpportunities.length > 0) {
            html += `<div class="summary-item"><span class="summary-label">å­æ©Ÿæœƒ (${childOpportunities.length})</span></div><ul style="list-style: none; padding-left: 1rem; margin-top: 0.5rem;">`;
            childOpportunities.forEach(child => { html += `<li style="margin-bottom: 0.5rem;"><a href="#" class="text-link" onclick="event.preventDefault(); CRM_APP.navigateTo('opportunity-details', { opportunityId: '${child.opportunityId}' })">${child.opportunityName}</a></li>`; });
            html += `</ul>`;
        }
        if (!parentOpportunity && (!childOpportunities || childOpportunities.length === 0)) html = '<div class="alert alert-info">å°šç„¡é—œè¯æ©Ÿæœƒã€‚</div>';
        container.innerHTML = html;
    }
    return { render, _handleRemoveParentLink };
})();